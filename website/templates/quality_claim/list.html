{% extends "base.html" %}
{% block title %}Quality Claims{% endblock %}

{% block content %}

<br/>
<h2 align="center">Quality Claims</h2>
<br/>

<div style="text-align: center;">

    <form action="" method="POST" align="center">
        <input type="button" class="btn btn-primary btn-sm" onclick="location.href='/quality_claim/create'"
        value="CREATE QUALITY CLAIM" />
        <button formaction="/download" type="submit" class="btn btn-primary btn-sm">DOWNLOAD</button>
    </form>

</div>

<br />
<br/>
<h6 align="center">Select fields to display.</h6>


<div style="text-align: center; margin-bottom: 20px;">
    <!-- <label for="column-selector">Select Columns to Display:</label> -->
    <select id="column-selector" multiple="multiple" style="width: 400px;">
        <option value="0" selected>Status</option>
        <option value="1" selected>Customer</option>
        <option value="2" selected>Report Date</option>
        <option value="3" >Application</option>
        <option value="4" selected>Model</option>
        <option value="5" >Type</option>
        <option value="6" selected>Issue</option>
        <option value="7" >Corrective Action</option>
        <option value="8" >Closed Date</option>
        <option value="9" selected>Latest Note</option>
        <option value="10" selected>Latest Date</option>

    </select>
</div>
<div style="display: flex; justify-content: center;">
    <table id="list" class="display stripe compact" style="width: 95%; ">
        <thead>
            <tr>
                <th>Status</th>
                <th>Customer</th>
                <th>Report Date</th>
                <th>Application</th>
                <th>Model</th>
                <th>Type</th>
                <th>Issue</th>
                <th>Corrective Action</th>
                <th>Closed Date</th>
                <th>Latest Note</th>
                <th>Latest Date</th>

            </tr>
            <tr>
                <th ><input type="text" data-column="0" class="filter-input" placeholder="Filter Status"></th>
                <th ><input type="text" data-column="1" class="filter-input" placeholder="Filter Customer"></th>
                <th><input type="text" data-column="2" class="filter-input" placeholder="Filter Report Date"></th>
                <th><input type="text" data-column="3" class="filter-input" placeholder="Filter Application"></th>
                <th><input type="text" data-column="4" class="filter-input" placeholder="Filter Model"></th>
                <th><input type="text" data-column="5" class="filter-input" placeholder="Filter Type"></th>
                <th><input type="text" data-column="6" class="filter-input" placeholder="Filter Issue"></th>
                <th><input type="text" data-column="7" class="filter-input" placeholder="Filter Corrective Action"></th>
                <th><input type="text" data-column="8" class="filter-input" placeholder="Filter Closed Date"></th>
                <th><input type="text" data-column="9" class="filter-input" placeholder="Filter Latest Note"></th>
                <th><input type="text" data-column="10" class="filter-input" placeholder="Filter Latest Date"></th>

            </tr>
        </thead>

        <tbody>
            {% for quality_claim in list %}
            <tr>
                <td>
                    {{ quality_claim.status }}
                </td>
                <td>
                    <a href="/quality_claim/display/{{ quality_claim.id }}">{{ quality_claim.customer }}</a>
                </td>
                <td>
                    {{ quality_claim.report_date }}
                </td>
                <td>
                    {{ quality_claim.application }}
                </td>
                <td>
                    <a href="/quality_claim/display/{{ quality_claim.id }}">{{ quality_claim.model }}</a>
                </td>
                <td>
                    {{ quality_claim.type }}
                </td>
                <td>
                    {{ quality_claim.issue }}
                </td>
                <td>
                    {{ quality_claim.corrective_action }}
                </td>
                <td>
                    {{ quality_claim.closed_date }}
                </td>

                <td>
                    {{ quality_claim.latest_note }}
                </td>
                <td>
                    {{ quality_claim.latest_date }}
                </td>


            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>


<script>
document.addEventListener("DOMContentLoaded", function() {
    // Initialize DataTable
    var table = $('#list').DataTable({
        paging: true,
        searching: true,
        ordering: true,
        order: [[0, 'asc']], // Orders by Status initially
        pageLength: 100,
        autoWidth: false, // Set to false to respect the widths defined below
        columnDefs: [
            { targets: '_all', className: 'dt-body-left'},
            { targets: 0, width: '8%' },   // Status
            { targets: 1, width: '10%' },  // Customer
            { targets: 2, width: '8%' },   // Report Date
            { targets: 3, width: '8%' },   // Application
            { targets: 4, width: '10%' },  // Model
            { targets: 5, width: '8%' },   // Type
            { targets: 6, width: '15%' },  // Issue
            { targets: 7, width: '15%' },  // Corrective Action
            { targets: 8, width: '8%' },   // Closed Date
            { targets: 9, width: '15%' },  // Latest Note           
            { targets: 10, width: '8%' },  // Latest Date
        ],
        responsive: true
    });

    // Initialize Select2
    $('#column-selector').select2({
        placeholder: "Select columns",
        allowClear: true
    });

    // Function to update column visibility
    function updateColumnVisibility() {
        var selectedColumns = $('#column-selector').val() || [];
        var selectedColumnIndices = selectedColumns.map(Number);

        table.columns().every(function(index) {
            var isVisible = selectedColumnIndices.includes(index);
            this.visible(isVisible);
            // Sync visibility of the filter inputs in the second header row
            $('.filter-input[data-column="' + index + '"]').closest('th').toggle(isVisible);
        });
    }

    // Handle column visibility changes
    $('#column-selector').on('change', function() {
        updateColumnVisibility();
    });

    // --- FIXED: Default Status filter targets index 0 ---
    const statusColumnIndex = 0; 
    const defaultStatusFilterValue = 'New, On going'; 

    // Set value in the UI filter box
    $(`.filter-input[data-column="${statusColumnIndex}"]`).val(defaultStatusFilterValue);

    // Apply the regex search for "New OR On going"
    var filterValues = defaultStatusFilterValue.split(',').map(item => item.trim());
    var regex = filterValues.join('|');
    table.column(statusColumnIndex).search(regex, true, false).draw();
    // --- End Filter Fix ---

    // Individual Column Filtering logic
    $('.filter-input').on('keyup', function () {
        var colIdx = $(this).data('column');
        var filterVal = this.value;
        
        // Supports comma-separated filtering (e.g., "Apple, Samsung")
        var filterValues = filterVal.split(',').map(item => item.trim());
        var regex = filterValues.join('|');
        
        table.column(colIdx)
            .search(regex, true, false)
            .draw();
    });

    // Run visibility check on load
    updateColumnVisibility();
});


</script>

{% endblock %}