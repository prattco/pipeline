{% extends "base.html" %}
{% block title %}Quality Claims{% endblock %}

{% block content %}

<br/>
<h2 align="center">Quality Claims</h2>
<br/>

<div style="text-align: center;">

    <form action="" method="POST" align="center">
        <input type="button" class="btn btn-primary btn-sm" onclick="location.href='/quality_claim/create'"
        value="CREATE QUALITY CLAIM" />
        <!-- <button formaction="/download" type="submit" class="btn btn-primary btn-sm">DOWNLOAD</button> -->
    </form>

</div>

<br />
<br/>
<h6 align="center">Select fields to display.</h6>


<div style="text-align: center; margin-bottom: 20px;">
    <!-- <label for="column-selector">Select Columns to Display:</label> -->
    <select id="column-selector" multiple="multiple" style="width: 400px;">
        <option value="0" selected>Status</option>
        <option value="1" selected>Customer</option>
        <option value="2" selected>Report Date</option>
        <option value="3" >Application</option>
        <option value="4" selected>Model</option>
        <option value="5" >Type</option>
        <option value="6" selected>RMA No</option>
        <option value="7" selected>Failure Location</option>
        <option value="8" >Serial No</option>
        <option value="9" >Credit Memo</option>
        <option value="10" selected>Issue</option>
        <option value="11" >Corrective Action</option>
        <option value="12" >Closed Date</option>
        <option value="13" selected>Latest Note</option>
        <option value="14" selected>Latest Date</option>

    </select>
</div>
<div style="display: flex; justify-content: center;">
    <table id="list" class="display stripe compact" style="width: 95%; ">
        <thead>
            <tr>
                <th>Status</th>
                <th>Customer</th>
                <th>Report Date</th>
                <th>Application</th>
                <th>Model</th>
                <th>Type</th>
                <th>RMA No</th>
                <th>Failure Location</th>
                <th>Serial No</th>
                <th>Credit Memo</th>
                <th>Issue</th>
                <th>Corrective Action</th>
                <th>Closed Date</th>
                <th>Latest Note</th>
                <th>Latest Date</th>

            </tr>
            <tr>
                <th ><input type="text" data-column="0" class="filter-input" placeholder="Filter Status"></th>
                <th ><input type="text" data-column="1" class="filter-input" placeholder="Filter Customer"></th>
                <th><input type="text" data-column="2" class="filter-input" placeholder="Filter Report Date"></th>
                <th><input type="text" data-column="3" class="filter-input" placeholder="Filter Application"></th>
                <th><input type="text" data-column="4" class="filter-input" placeholder="Filter Model"></th>
                <th><input type="text" data-column="5" class="filter-input" placeholder="Filter Type"></th>
                <th><input type="text" data-column="6" class="filter-input" placeholder="Filter RMA No"></th>
                <th><input type="text" data-column="7" class="filter-input" placeholder="Filter Failure Location"></th>
                <th><input type="text" data-column="8" class="filter-input" placeholder="Filter Serial No"></th>
                <th><input type="text" data-column="9" class="filter-input" placeholder="Filter Credit Memo"></th>
                <th><input type="text" data-column="10" class="filter-input" placeholder="Filter Issue"></th>
                <th><input type="text" data-column="11" class="filter-input" placeholder="Filter Corrective Action"></th>
                <th><input type="text" data-column="12" class="filter-input" placeholder="Filter Closed Date"></th>
                <th><input type="text" data-column="13" class="filter-input" placeholder="Filter Latest Note"></th>
                <th><input type="text" data-column="14" class="filter-input" placeholder="Filter Latest Date"></th>

            </tr>
        </thead>

        <tbody>
            {% for quality_claim in claims %}
            <tr>
                <td>
                    {{ quality_claim.status }}
                </td>
                <td>
                    <a href="/quality_claim/display/{{ quality_claim.id }}">{{ quality_claim.customer }}</a>
                </td>
                <td>
                    {{ quality_claim.report_date }}
                </td>
                <td>
                    {{ quality_claim.application }}
                </td>
                <td>
                    <a href="/quality_claim/display/{{ quality_claim.id }}">{{ quality_claim.model }}</a>
                </td>
                <td>
                    {{ quality_claim.type }}
                </td>


                <td>
                    {{ quality_claim.rma_no }}
                </td>
                <td>
                    {{ quality_claim.failure_loc }}
                </td>
                <td>
                    {{ quality_claim.serial_no }}
                </td>
                <td>
                    {{ quality_claim.credit_memo }}
                </td>


                <td>
                    {{ quality_claim.issue }}
                </td>
                <td>
                    {{ quality_claim.corrective_action }}
                </td>
                <td>
                    {{ quality_claim.closed_date }}
                </td>

                <td>
                    {{ quality_claim.latest_note }}
                </td>
                <td>
                    {{ quality_claim.latest_date }}
                </td>


            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Initialize DataTable
        var table = $('#list').DataTable({
            paging: true,
            searching: true,
            ordering: true,
            order: [[0, 'asc']], 
            pageLength: 100,
            autoWidth: false, 
            columnDefs: [
                { targets: '_all', className: 'dt-body-left'},
                // Width adjustments for 15 columns (Indices 0-14)
                { targets: [0, 2, 3, 5, 12, 14], width: '5%' },   // Status, Dates, App, Type
                { targets: [1, 4, 6, 8, 9], width: '7%' },      // IDs, Customer, Model
                { targets: 7, width: '10%' },                    // Failure Location
                { targets: [10, 11, 13], width: '15%' },         // Long text fields (Issue, Action, Note)
            ],
            responsive: true
        });
    
        // Initialize Select2
        $('#column-selector').select2({
            placeholder: "Select columns",
            allowClear: true
        });
    
        // Function to update column visibility
        function updateColumnVisibility() {
            var selectedColumns = $('#column-selector').val() || [];
            var selectedColumnIndices = selectedColumns.map(Number);
    
            table.columns().every(function(index) {
                var isVisible = selectedColumnIndices.includes(index);
                this.visible(isVisible);
                // Sync visibility of the filter inputs in the second header row
                $('.filter-input[data-column="' + index + '"]').closest('th').toggle(isVisible);
            });
        }
    
        $('#column-selector').on('change', function() {
            updateColumnVisibility();
        });
    
        // Default Status filter (Index 0)
        const statusColumnIndex = 0; 
        const defaultStatusFilterValue = 'Open'; 
    
        $(`.filter-input[data-column="${statusColumnIndex}"]`).val(defaultStatusFilterValue);
        var filterValues = defaultStatusFilterValue.split(',').map(item => item.trim());
        var regex = filterValues.join('|');
        table.column(statusColumnIndex).search(regex, true, false).draw();
    
        // Individual Column Filtering logic
        $('.filter-input').on('keyup', function () {
            var colIdx = $(this).data('column');
            var filterVal = this.value;
            
            var filterValues = filterVal.split(',').map(item => item.trim());
            var regex = filterValues.join('|');
            
            table.column(colIdx)
                .search(regex, true, false)
                .draw();
        });
    
        // Run visibility check on load
        updateColumnVisibility();
    });
    </script>

{% endblock %}